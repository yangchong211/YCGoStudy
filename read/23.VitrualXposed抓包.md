# VirtualXposed 进行 Charles https 抓包
#### 目录介绍
- 01.背景分析思考
- 03.具体操作步骤
- 04.ssl-pinning




### 01.背景分析思考
- Android7.0以上Https抓包困境
    - 主要有两个问题：证书校验无法抓包，https数据加密无法正常查看数据
- 有3种方法可以解决这个问题：
    - 最暴力的，root，把证书加入到系统证书。但是现在root本身就是挺难的事情，root失败容易成砖
    - 如果是自家APP，在APP中设置信任用户证书和添加权限即可
    - 如果是其他App，通过VirtualXposed+插件绕过证书检查（本文）



### 03.具体操作步骤
- 首先下载安装VirtualXposed（免刷）
    - 直接下载安装，地址：https://github.com/android-hacker/VirtualXposed/releases
    - 作用：VirtualXposed 是基于VirtualApp 和 epic 在非ROOT环境下运行Xposed模块的实现
    - 简单来说：VirtualXposed 制作了一个虚拟环境（可以理解为虚拟机），该虚拟环境中内置Xposed环境，用户只需将软件安装到该虚拟环境中，就能使用xposed的功能了。
- 然后下载安装TrustMeAlready
    - 直接下载安装，地址：https://github.com/ViRb3/TrustMeAlready/releases
    - 作用：Android上禁用SSL验证和固定
    - 安装后，然后使用使用VirtualXposed应用中添加应用把该app添加进来
- 最后在VirtualXposed中安装目标apk
    - 比如最后需要爬作业帮数据，则在VirtualXposed工具中安装该apk，类似在虚拟机中安装
- 完成操作后最终开始抓包
    - 可以在VirtualXposed框架内打开任意的app都可以成功取到HTTPS流量
- 测试实验
    - 测试豆神教育/豆神直播课线上包，直接抓取https数据都是unknown。但是如果是加载到VirtualXposed工具中，则可以突破权限抓起到https数据


### 04.ssl-pinning
- 有时候系统证书也装了，但是部分 APP 还是抓不到包，那么大概率就是使用了 SSL Pinning
    - 常用的套路是对校验证书的代码进行 hook，即对特定类的特定方法的返回值进行替换
    - JustTrustMe 里面配置了一堆的常见 http 请求库的类名和方法名，但是如果 Android 在打包的时候开启了混淆就没办法了，所以最佳的方式还是反编译找到相关代码然后配合 Frida 进行 hook
- 目前情况
    - 目前有一些 APP 可以实现无 root 安装 Xposed 插件，比如太极(阴)，VirtualXposed。但是需要卸载原软，然后对安装包进行二次安装，同时也无法保证所有软件正常工作。
    - 目前最优的办法是安装 Magisk 里面的 taichi 插件，然后激活太极(阴)变成太极(阳)，就可以实现无需重装 app 的情况下使用 Xposed 插件插件




- https://testerhome.com/articles/18609
- https://www.jianshu.com/p/b97c0aafa351
- Android 7.0+使用VirtualXposed+Charles进行抓包
    - https://www.jianshu.com/p/b97c0aafa351
- 为了抓包某app,我折腾了10天
    - http://www.yilingsj.com/xwzj/2019-03-25/ssl-pinning.html
- 手把手教你写爬虫
    - https://github.com/locoz666/spider-article





