# VirtualXposed抓包
#### 目录介绍
- 01.背景分析思考
- 02.ssl-pinning
- 03.具体操作步骤
- 04.部分apk启动失败
- 05.遇到问题点分析
- 06.Hook学而思



### 01.背景分析思考
- Android7.0以上Https抓包困境
    - 主要有两个问题：证书校验无法抓包，https数据加密无法正常查看数据
- 有3种方法可以解决这个问题：
    - 最暴力的，root，把证书加入到系统证书。但是现在root本身就是挺难的事情，root失败容易成砖
    - 如果是自家APP，在APP中设置信任用户证书和添加权限即可。
    - 如果是其他App，通过VirtualXposed+插件绕过证书检查（本文）


### 02.ssl-pinning
- SSL Pinning
    - 技术指的是在应用程序中只信任固定证书或是公钥。
- SSL pinning的作用
    - 在测试一个应用的时候会设置代理，从而获取应用在运行过程中的流量。
    - 使用代理工具获取流量的话，需要在设备中安装我们自己的证书到可信任的根证书中，这样应用程序才会将我们的证书视为可信任的有效证书，允许代理工具拦截应用的流量。
    - 但是使用的SSL pinning技术的应用程序，只信任指定的证书，那么我们就算把我们的证书安装到设备中，应用程序也不会信任我们的证书，这样的话我们就不能通过代理的方式来拦截应用的流量。
- App为何无法抓包
    - 在于SSLPinning（证书绑定），也就是客户端在收到服务器的证书后，对该证书进行强校验，验证该证书是不是客户端承认的证书，如果不是，则直接断开连接，而且客户端承认的证书会在应用发布的时候打包进去
- 如何突破
    - 使用hook解决，如果抓包的目标Apk混淆或者加固，如何避免hook失败？另外怎么去hook别的app，以及hook的时机……



### 03.具体操作步骤
- 首先下载安装VirtualXposed（免刷）
    - 直接下载安装，地址：https://github.com/android-hacker/VirtualXposed/releases
    - 作用：VirtualXposed 是基于VirtualApp 和 epic 在非ROOT环境下运行Xposed模块的实现
    - 简单来说：VirtualXposed 制作了一个虚拟环境（可以理解为虚拟机），该虚拟环境中内置Xposed环境，用户只需将软件安装到该虚拟环境中，就能使用xposed的功能了。
- 然后下载安装TrustMeAlready
    - 直接下载安装，地址：https://github.com/ViRb3/TrustMeAlready/releases
    - 作用：Android上禁用SSL验证和固定
    - 安装后，然后使用使用VirtualXposed应用中添加应用把该app添加进来
- 最后在VirtualXposed中安装目标apk
    - 比如最后需要爬作业帮数据，则在VirtualXposed工具中安装该apk，类似在虚拟机中安装
- 完成操作后最终开始抓包
    - 可以在VirtualXposed框架内打开任意的app都可以成功取到HTTPS流量
- 测试实验
    - 测试豆神教育/豆神直播课/笔神作文线上包，直接抓取https数据都是unknown。但是如果是加载到VirtualXposed工具中，则可以突破权限抓起到https数据



### 04.部分apk启动失败
- 经过测试
    - 发现豆神教育，豆神直播课，笔神教育，好学生作文，都是可以直接安装到vxp上，挂载都是成功的
- 部分安装失败
    - 比如作业帮，学而思，猿辅导等，无法挂载安装，报错提示安装错误。猜想这些应用对运行环境做了判断……
- 如何判断Xposed环境
    - 先判断手机是否root，xposed本质是使用反射，那么则可以通过xposed的类名去反射创建对象，如果创建成功则说明有xposed环境


### 05.遇到问题点分析
- 网上说：JustTrustMe + VirtualXposed即可
    - 有弊端，使用hook的方式去修改证书校验的结果，但是开发人员也可以使用代码混淆的办法来对抗hook
- 作业帮/学而思无法正常启动
    - 无法正常启动导致无法对app进行分析，因此需要找到app无法在虚拟机中不能启动的原因。找到原因后才能想办法突破


### 06.Hook学而思
- 目的
    - 要使学而思/作业帮等能正常运行在VirtualXposed工具中，这样可以为下一步抓取https接口打下基础
- 难点
    - 怎么修改代码/或者hook学而思中检查Xposed环境的代码，然后在什么时机注入才能生效，需要对xposed写插件有深入对理解








